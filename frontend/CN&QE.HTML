<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Complex Numbers â€” Expedition (Polished)</title>
<style>
  :root{
    --bg-1:#020316; --bg-2:#07102a;
    --accent1:#00ffd1; --accent2:#8a38ff;
    --panel: rgba(0,0,0,0.6);
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, monospace;background:linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#fff; overflow:hidden}
  /* Background canvas occupies full viewport */
  #stars { position:fixed; inset:0; z-index:0; display:block; }
  #stage { position:fixed; inset:0; z-index:1; pointer-events:auto; }
  /* Top UI */
  .ui {
    position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:6;
    width:86%; max-width:1280px; display:flex; align-items:center; gap:12px; justify-content:space-between;
    color:#eafefe;
  }
  .ui .title { font-weight:700; font-size:18px; letter-spacing:0.2px; }
  .progressWrap{ display:flex; align-items:center; gap:10px; width:48%; max-width:600px }
  .progressBar{ flex:1; height:10px; background:rgba(255,255,255,0.06); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,0.03)}
  .progressInner{ width:0%; height:100%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); transition:width .4s ease }
  .ui .controls{display:flex; gap:8px; align-items:center}
  .btn { background:rgba(255,255,255,0.04); padding:8px 12px; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.04); color:#fff }
  .btn.tog { display:flex; gap:8px; align-items:center; padding:6px 8px; font-size:13px }

  /* Dialogue box (typewriter) */
  #dialogue { position:fixed; left:50%; transform:translateX(-50%); bottom:34px; z-index:7; width:84%; max-width:1100px;
    background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(12,12,12,0.75)); border-radius:12px; padding:18px; display:none;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.04); font-size:15px; line-height:1.4;
  }
  #dialogue small { display:block; margin-top:10px; color:rgba(200,255,250,0.7); font-size:13px }

  /* Player (dr neutron + rayquaza) */
  #player { position:absolute; width:160px; height:96px; transform:translate(-50%,-50%); z-index:5; pointer-events:none; }
  .ray { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:160px; height:60px; border-radius:12px; overflow:visible;
    display:flex; align-items:center; justify-content:center; }
  /* sprite placeholders - replace with images */
  .ray .body { width:120px; height:42px; border-radius:8px; background:linear-gradient(90deg,#18333a,#0fb4a6); box-shadow:0 8px 20px rgba(0,0,0,0.6); }
  .ray .wingL, .ray .wingR { position:absolute; width:56px; height:14px; background:linear-gradient(90deg,#00e6d1,#6ad5ff); border-radius:8px; top:-6px; }
  .ray .wingR{ right:12px; left:auto; transform-origin:right center }
  .ray .wingL{ left:12px; transform-origin:left center }
  @keyframes wingFlap { 0%{transform:rotate(-12deg)}50%{transform:rotate(12deg)}100%{transform:rotate(-12deg)} }
  .ray .wingL{ animation: wingFlap .42s ease-in-out infinite }
  .ray .wingR{ animation: wingFlap .42s ease-in-out infinite; animation-delay:.06s }

  .pilot { position:absolute; bottom:42px; left:50%; transform:translateX(-50%); width:44px; height:44px; border-radius:6px; background:linear-gradient(#f8d2c2,#d66e4f); display:flex; align-items:center; justify-content:center; font-weight:800; color:#120707; border:2px solid rgba(0,0,0,0.22); box-shadow:0 6px 18px rgba(0,0,0,0.6) }

  /* Asteroids */
  .asteroid {
    position:absolute; width:120px; height:120px; border-radius:50%; z-index:3; pointer-events:auto; user-select:none;
    background: radial-gradient(circle at 30% 25%, #6b6b6b, #3b3b3b); box-shadow: 0 10px 36px rgba(0,0,0,0.6), inset 0 -12px 22px rgba(0,0,0,0.35);
    display:flex; align-items:center; justify-content:center; overflow:visible; transition:transform .25s ease;
  }
  .asteroid .label { position:absolute; bottom:-22px; left:50%; transform:translateX(-50%); font-weight:700; color:#fff; font-size:13px; text-shadow:0 6px 18px rgba(0,0,0,0.6) }
  .asteroid .tail { position:absolute; left:-64px; top:30%; width:64px; height:36px; border-radius:20px 0 0 20px; background:linear-gradient(90deg,#ff862e,#ff3a3a); filter:blur(.2px); opacity:.95; transform-origin:right center; animation:tailFlow .85s linear infinite }
  @keyframes tailFlow { 0%{ transform:translateX(0) scaleX(1) } 50%{ transform:translateX(-8px) scaleX(1.07) } 100%{ transform:translateX(0) scaleX(1) } }
  .asteroid .crater{ width:70%; height:70%; border-radius:50%; background:radial-gradient(circle at 35% 30%, rgba(255,255,255,0.03), rgba(0,0,0,0.22)); opacity:.9 }

  /* asteroid floating animation (via JS transforms) */
  .asteroid.destroyed { opacity:0; transform:scale(.6) rotate(28deg); pointer-events:none; transition: all .9s ease-in; }

  /* Modal for lesson panel */
  .modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:9; width:86%; max-width:1100px; background: rgba(3,6,10,0.96); border-radius:12px; padding:16px; display:none; box-shadow: 0 24px 80px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.04) }
  .modal-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px }
  .modal-title{ font-weight:800; font-size:18px }
  .tabs{ display:flex; gap:8px; margin-bottom:10px }
  .tab { padding:8px 12px; border-radius:8px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.03); cursor:pointer }
  .tab.active{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#041018; font-weight:800; border:none }
  .panel { background: rgba(255,255,255,0.02); padding:12px; border-radius:8px; max-height:320px; overflow:auto; color:#eafefe }
  .task{ display:flex; gap:12px; align-items:center; padding:10px 8px; border-radius:8px; background:transparent }
  .task label{ display:flex; gap:10px; align-items:center; color:#fff }
  .cleanBtn { margin-top:12px; padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:800; letter-spacing:0.4px }
  .cleanBtn.disabled{ background:rgba(255,255,255,0.04); color:rgba(255,255,255,0.6); cursor:not-allowed }
  .cleanBtn.ready{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#041018 }

  /* small responsive tweaks */
  @media (max-width:900px){
    .ui { width:94% }
    .progressWrap { width:48% }
    .asteroid { width:90px; height:90px }
    #player { transform:translate(-50%,-50%) scale(.9) }
  }
</style>
<link href="chatbot/static/css/main.99047ad9.css" rel="stylesheet">
</head>
<body>

<canvas id="stars"></canvas>

<div id="stage" aria-hidden="false">
  <!-- player -->
  <div id="player" style="left:50%; top:62%">
    <div class="pilot" aria-hidden="true">DN</div>
    <div class="ray" aria-hidden="true">
      <div class="wingL raywing"></div>
      <div class="body"></div>
      <div class="wingR raywing"></div>
    </div>
  </div>
</div>

<!-- UI top -->
<div class="ui" role="banner" aria-label="Chapter UI">
  <div class="title">Complex Numbers â€” Expedition</div>
  <div class="progressWrap" aria-hidden="false">
    <div class="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
      <div id="progressInner" class="progressInner"></div>
    </div>
    <div id="progressText" class="progressLabel">0%</div>
  </div>
  <div class="controls">
    <button id="soundToggle" class="btn tog" title="Toggle Sound">ðŸ”ˆ Sound</button>
    <button id="resetBtn" class="btn" title="Reset Progress">Reset</button>
    <button id="helpBtn" class="btn" title="Help">Help</button>
  </div>
</div>

<!-- dialogue -->
<div id="dialogue" role="dialog" aria-live="polite" aria-atomic="true">
  <div id="dialogueTxt"></div>
  <small>Press <strong>SPACE</strong> to continue</small>
</div>

<!-- lesson modal -->
<div id="lessonModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-header">
    <div>
      <div id="modalTitle" class="modal-title">Subtopic</div>
      <div id="modalSub" style="color:rgba(200,255,250,0.8); font-size:13px">Theory â€¢ Video â€¢ Practice</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
      <div id="modalStatus" style="color:rgba(200,255,250,0.9)">Not started</div>
      <button id="closeModal" class="btn">Close</button>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <div class="tab active" data-target="theory">Theory</div>
    <div class="tab" data-target="video">Video Lectures</div>
    <div class="tab" data-target="practice">Practice</div>
  </div>

  <div id="theory" class="panel" data-panel>
    <div id="theoryList"></div>
  </div>
  <div id="video" class="panel" data-panel style="display:none">
    <div id="videoList"></div>
  </div>
  <div id="practice" class="panel" data-panel style="display:none">
    <div id="practiceList"></div>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px">
    <div style="color:rgba(200,255,250,0.85)">Complete each group, then press CLEAN THE MESS</div>
    <button id="cleanBtn" class="cleanBtn disabled" aria-disabled="true">CLEAN THE MESS</button>
  </div>
</div>

<script>
/* ---------------------------
  Polished interactive exploration page
  - smooth player movement
  - floating asteroids with tails
  - modal with 3 tabs (theory/video/practice)
  - "CLEAN THE MESS" when all three groups done
  - progress persistence in localStorage
  - dialog intro with typewriter
----------------------------*/

/* --------- Configurable content map (subtopics) --------- */
/* Add/modify content as desired. Keys must match asteroid labels. */
const contentMap = {
  "Argand Plane": {
    theory: ["Definition of Argand plane", "Plotting complex numbers", "Distance and midpoint in Argand plane"],
    videos: [{title:"Argand Plane basics (lecture)", url:"#"}],
    practice: ["Plot z=3+4i", "Find midpoint of (1+2i) and (3+4i)"]
  },
  "Polar Representation": {
    theory: ["Polar form r(cosÎ¸ + i sinÎ¸)", "Modulus and argument conversion", "Euler's formula relation"],
    videos: [{title:"Polar form & Euler", url:"#"}],
    practice: ["Convert between forms", "Compute modulus & arg for given z"]
  },
  "De Moivre": {
    theory: ["De Moivre's theorem statement", "Use for powers and roots", "nth roots of complex numbers"],
    videos: [{title:"De Moivre explained", url:"#"}],
    practice: ["Find roots of unity", "Use De Moivre for (cosÎ¸ + i sinÎ¸)^n"]
  },
  "Roots of Unity": {
    theory: ["nth roots of unity geometry", "Properties and sums", "Cyclotomic relations"],
    videos: [{title:"Roots of unity visual", url:"#"}],
    practice: ["List cube roots of unity", "Sum of all nth roots"]
  },
  "Quadratic Applications": {
    theory: ["Quadratic with complex roots", "Vieta relations for complex roots", "Parameter constraints"],
    videos: [{title:"Quadratics & complex roots", url:"#"}],
    practice: ["Find parameter values for real roots", "Form quadratic with given roots"]
  },
  "JEE PYQs": {
    theory: ["Pattern of PYQs", "Important question-types to practice"],
    videos: [{title:"PYQ analysis", url:"#"}],
    practice: ["2024 PYQ set", "2023 PYQ set", "2022 PYQ set"]
  }
};

/* --------- DOM references --------- */
const stage = document.getElementById('stage');
const stars = document.getElementById('stars');
const playerEl = document.getElementById('player');
const dialogue = document.getElementById('dialogue');
const dialogueTxt = document.getElementById('dialogueTxt');
const progressInner = document.getElementById('progressInner');
const progressText = document.getElementById('progressText');
const lessonModal = document.getElementById('lessonModal');
const modalTitle = document.getElementById('modalTitle');
const modalSub = document.getElementById('modalSub');
const modalStatus = document.getElementById('modalStatus');
const theoryList = document.getElementById('theoryList');
const videoList = document.getElementById('videoList');
const practiceList = document.getElementById('practiceList');
const cleanBtn = document.getElementById('cleanBtn');
const closeModal = document.getElementById('closeModal');
const soundToggle = document.getElementById('soundToggle');
const resetBtn = document.getElementById('resetBtn');
const helpBtn = document.getElementById('helpBtn');

/* --------- Audio placeholders (optional) --------- */
let AUDIO_ENABLED = false;
const sfx = {
  click: new Audio(), // set src later if you have files
  explosion: new Audio(),
  collect: new Audio()
};
soundToggle.addEventListener('click', ()=>{
  AUDIO_ENABLED = !AUDIO_ENABLED;
  soundToggle.textContent = AUDIO_ENABLED ? 'ðŸ”Š Sound ON' : 'ðŸ”ˆ Sound';
});

/* --------- Canvas starfield (parallax twinkle) --------- */
stars.width = innerWidth; stars.height = innerHeight;
const sctx = stars.getContext('2d');
let starData = [];
function genStars(){
  starData = [];
  const count = Math.round((innerWidth * innerHeight) / 6000);
  for (let i=0;i<count;i++){
    starData.push({
      x: Math.random()*innerWidth,
      y: Math.random()*innerHeight,
      r: Math.random()*1.6,
      alpha: 0.2 + Math.random()*0.8,
      tw: Math.random()*2 + 1.5,
      phase: Math.random()*Math.PI*2
    });
  }
}
function drawStars(t){
  sctx.clearRect(0,0,stars.width,stars.height);
  for (let s of starData){
    const a = s.alpha * (0.6 + 0.4*Math.sin(t*0.002*s.tw + s.phase));
    sctx.fillStyle = `rgba(255,255,255,${a})`;
    sctx.fillRect(s.x, s.y, s.r, s.r);
  }
}
window.addEventListener('resize', ()=>{
  stars.width = innerWidth; stars.height = innerHeight; genStars();
});
genStars();

/* --------- Player movement & physics --------- */
const player = { x: innerWidth/2, y: innerHeight*0.62, w: 160, h: 96, speed: 4 };
let keys = {};
window.addEventListener('keydown', (e)=>{ keys[e.key] = true; if (state==='dialogue' && e.code==='Space') advanceDialogue(); });
window.addEventListener('keyup', (e)=>{ keys[e.key] = false; });

function updatePlayer(){
  let vx = 0, vy = 0;
  if (keys['ArrowLeft'] || keys['a']) vx = -player.speed;
  if (keys['ArrowRight'] || keys['d']) vx = player.speed;
  if (keys['ArrowUp'] || keys['w']) vy = -player.speed;
  if (keys['ArrowDown'] || keys['s']) vy = player.speed;
  // smoother movement: gentle lerp to velocity
  player.x = Math.max(40, Math.min(innerWidth - player.w/2, player.x + vx));
  player.y = Math.max(80, Math.min(innerHeight - player.h/2, player.y + vy));
  playerEl.style.left = (player.x) + 'px';
  playerEl.style.top = (player.y) + 'px';
}

/* --------- Asteroids spawning & behavior --------- */
let asteroids = []; // {id, el, x,y, r, destroyed, cooldown}
function spawnAsteroids(){
  // arrange asteroids around center circle
  const keys = Object.keys(contentMap);
  const centerX = innerWidth/2, centerY = innerHeight/2;
  const radius = Math.min(innerWidth, innerHeight)/3.2;
  for (let i=0;i<keys.length;i++){
    const ang = (i / keys.length) * Math.PI * 2;
    const jitter = (Math.random() - 0.5) * 0.6;
    const cx = centerX + Math.cos(ang + jitter) * (radius * (0.8 + Math.random()*0.4));
    const cy = centerY + Math.sin(ang + jitter) * (radius * (0.8 + Math.random()*0.4));
    const size = 90 + Math.random()*40;
    const el = document.createElement('div');
    el.className = 'asteroid';
    el.style.left = (cx - size/2) + 'px';
    el.style.top = (cy - size/2) + 'px';
    el.style.width = size + 'px';
    el.style.height = size + 'px';
    // tail
    const tail = document.createElement('div'); tail.className = 'tail';
    // randomly choose tail color blue/orange occasionally
    if (Math.random() < 0.28) tail.style.background = 'linear-gradient(90deg,#00bfff,#5ef1ff)';
    el.appendChild(tail);
    const crater = document.createElement('div'); crater.className='crater';
    el.appendChild(crater);
    const label = document.createElement('div'); label.className='label'; label.textContent = keys[i];
    el.appendChild(label);
    stage.appendChild(el);
    asteroids.push({ id: keys[i], el, x: cx, y: cy, r: size/2, destroyed:false, cooldown:0 });
    // click to open lesson as well
    el.addEventListener('click', ()=>{ if (!asteroids.find(a=>a.el===el).destroyed) showLessonFor(el); } );
  }
}
spawnAsteroids();

/* slight drift animation using requestAnimationFrame */
let t0 = performance.now();
function driftAsteroids(t){
  const now = t;
  for (let i=0;i<asteroids.length;i++){
    const a = asteroids[i];
    if (a.destroyed) continue;
    const dx = Math.sin((now*0.001) * (0.4 + i*0.07)) * (6 + (i%3));
    const dy = Math.cos((now*0.001) * (0.6 + i*0.05)) * (6 + ((i+1)%4));
    a.el.style.transform = `translate(${dx}px, ${dy}px)`;
  }
  drawStars(now);
  requestAnimationFrame(driftAsteroids);
}
requestAnimationFrame(driftAsteroids);

/* --------- Collision detection (player center vs asteroid center) --------- */
let collisionDebounce = 600; // ms
function detectCollisions(){
  const pcx = player.x + 10; // adjust center a bit forward for "riding" feel
  const pcy = player.y;
  for (let a of asteroids){
    if (a.destroyed) continue;
    const rect = a.el.getBoundingClientRect();
    const ax = rect.left + rect.width/2;
    const ay = rect.top + rect.height/2;
    const dist = Math.hypot(pcx - ax, pcy - ay);
    if (dist < a.r + 14 && Date.now() - (a.lastHit||0) > collisionDebounce){
      a.lastHit = Date.now();
      // open lesson modal for asteroid 'a'
      openLessonModal(a);
      break; // handle one at a time
    }
  }
}

/* --------- Progress tracking (localStorage) --------- */
const PROG_KEY = 'clario_complex_progress_v1';
let savedProgress = JSON.parse(localStorage.getItem(PROG_KEY) || '{}'); // keys: asteroid id -> destroyed bool
function loadProgress(){
  for (let a of asteroids){
    if (savedProgress[a.id]) {
      markAsteroidDestroyed(a, false /*no animation*/);
    }
  }
  updateProgressUI();
}
function saveProgress(){ localStorage.setItem(PROG_KEY, JSON.stringify(savedProgress)); }

/* --------- Dialogue (typewriter) --------- */
const dialogues = [
  "Dr. Neutron: The Complex Quadrant hums with imaginary charge. Those asteroids hide concepts we must tidy up.",
  "Dr. Neutron: Mount Rayquaza and approach each floating comet. Study theory, watch the lecture, solve practice â€” then CLEAN THE MESS.",
  "Controls: Arrow keys or WASD to move. Press SPACE to continue.",
  "Press SPACE to begin the mission..."
];
let dIndex = 0, typing = false;
function showDialogue(text, cb){
  dialogue.style.display = 'block';
  dialogueTxt.textContent = '';
  typing = true;
  let i=0;
  function tick(){
    if (i < text.length) { dialogueTxt.textContent += text.charAt(i); i++; setTimeout(tick, 24); }
    else { typing = false; if (cb) cb(); }
  }
  tick();
}
function advanceDialogue(){
  if (typing) return;
  if (dIndex < dialogues.length) { showDialogue(dialogues[dIndex]); dIndex++; }
  else { dialogue.style.display = 'none'; state = 'explore'; }
}
advanceDialogue();

/* --------- Lesson modal behavior --------- */
let activeAsteroid = null;
function showLessonFor(el){
  const a = asteroids.find(x=>x.el===el);
  if (a) openLessonModal(a);
}
function openLessonModal(a){
  activeAsteroid = a;
  lessonModal.style.display = 'block';
  lessonModal.setAttribute('aria-hidden','false');
  modalTitle.textContent = a.id;
  modalSub.textContent = "Subtopic â€” " + a.id;
  modalStatus.textContent = savedProgress[a.id] ? 'Cleared' : 'In Progress';
  // fill lists
  const content = contentMap[a.id] || { theory:[], videos:[], practice:[] };
  theoryList.innerHTML = ''; videoList.innerHTML = ''; practiceList.innerHTML = '';
  content.theory.forEach((t,idx)=>{
    const div = document.createElement('div'); div.className='task';
    const lbl = document.createElement('label');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.group='theory';
    cb.addEventListener('change', onTaskChange);
    const span = document.createElement('span'); span.textContent = t;
    lbl.appendChild(cb); lbl.appendChild(span); div.appendChild(lbl); theoryList.appendChild(div);
  });
  (content.videos||[]).forEach((v,idx)=>{
    const div = document.createElement('div'); div.className='task';
    const lbl = document.createElement('label');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.group='video';
    cb.addEventListener('change', onTaskChange);
    const span = document.createElement('span'); span.textContent = v.title + " (placeholder)";
    lbl.appendChild(cb); lbl.appendChild(span); div.appendChild(lbl); videoList.appendChild(div);
  });
  (content.practice||[]).forEach((p,idx)=>{
    const div = document.createElement('div'); div.className='task';
    const lbl = document.createElement('label');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.group='practice';
    cb.addEventListener('change', onTaskChange);
    const span = document.createElement('span'); span.textContent = p;
    lbl.appendChild(cb); lbl.appendChild(span); div.appendChild(lbl); practiceList.appendChild(div);
  });
  // if previously saved destroyed, mark checkboxes (all completed)
  const alreadyDone = !!savedProgress[a.id];
  if (alreadyDone){
    lessonModal.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked = true);
    enableClean(true);
  } else {
    lessonModal.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked = false);
    enableClean(false);
  }
}
closeModal.addEventListener('click', ()=>{ lessonModal.style.display='none'; lessonModal.setAttribute('aria-hidden','true'); activeAsteroid=null; });

/* tab switching */
lessonModal.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    lessonModal.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tgt = btn.dataset.target;
    lessonModal.querySelectorAll('[data-panel]').forEach(p=>p.style.display='none');
    document.getElementById(tgt).style.display='block';
  });
});

/* task change */
function onTaskChange(){ updateCleanCriteria(); }
function updateCleanCriteria(){
  if (!activeAsteroid) return;
  const th = [...theoryList.querySelectorAll('input[type=checkbox]')];
  const vd = [...videoList.querySelectorAll('input[type=checkbox]')];
  const pr = [...practiceList.querySelectorAll('input[type=checkbox]')];
  const thDone = th.length===0 ? true : th.every(x=>x.checked);
  const vdDone = vd.length===0 ? true : vd.every(x=>x.checked);
  const prDone = pr.length===0 ? true : pr.every(x=>x.checked);
  const ok = thDone && vdDone && prDone;
  enableClean(ok);
}

/* enable/disable clean button */
function enableClean(on){
  if (on){ cleanBtn.classList.remove('disabled'); cleanBtn.classList.add('ready'); cleanBtn.disabled=false; cleanBtn.setAttribute('aria-disabled','false'); }
  else { cleanBtn.classList.add('disabled'); cleanBtn.classList.remove('ready'); cleanBtn.disabled=true; cleanBtn.setAttribute('aria-disabled','true'); }
}

/* Clean the mess: destroy asteroid */
cleanBtn.addEventListener('click', ()=>{
  if (!activeAsteroid) return;
  const a = activeAsteroid;
  // play sfx
  if (AUDIO_ENABLED) { try{ sfx.explosion.play(); } catch(e){} }
  // visual explosion placeholder
  a.el.classList.add('destroyed');
  savedProgress[a.id] = true;
  saveProgress();
  // after animation remove element
  setTimeout(()=>{ try{ a.el.remove(); } catch(e){} }, 800);
  a.destroyed = true;
  lessonModal.style.display='none'; lessonModal.setAttribute('aria-hidden','true');
  activeAsteroid = null;
  updateProgressUI();
  // celebration small pop
  showTinyBadge("Cleared: " + a.id);
});

/* mark asteroid destroyed without modal (used for preloaded progress) */
function markAsteroidDestroyed(a, animate=true){
  a.destroyed = true;
  savedProgress[a.id] = true;
  a.el.classList.add('destroyed');
  if (!animate) a.el.remove();
}

/* progress UI */
function updateProgressUI(){
  const total = asteroids.length;
  const done = asteroids.filter(a=>a.destroyed || savedProgress[a.id]).length;
  const pct = Math.round((done/total) * 100);
  progressInner.style.width = pct + '%';
  progressText.textContent = pct + '%';
  if (pct===100) onAllCleared();
}

/* on complete all asteroids -> boss unlock */
function onAllCleared(){
  // show boss moon unlock animation
  showBigBadge("All subtopics cleared â€” Boss Moon Unlocked! Proceed to PYQs");
}

/* small visual badge */
function showTinyBadge(msg){
  const b = document.createElement('div');
  b.style.position='fixed'; b.style.zIndex=10; b.style.left='50%'; b.style.top='18%';
  b.style.transform='translateX(-50%) scale(.7)'; b.style.padding='10px 16px'; b.style.borderRadius='14px';
  b.style.background='linear-gradient(90deg,var(--accent1),var(--accent2))'; b.style.color='#041018'; b.style.fontWeight=800;
  b.textContent = msg;
  document.body.appendChild(b);
  setTimeout(()=>{ b.style.transition='transform .45s ease'; b.style.transform='translateX(-50%) scale(1)'; },40);
  setTimeout(()=>{ b.style.transition='opacity .6s ease'; b.style.opacity=0; setTimeout(()=>b.remove(),700); },3500);
}

/* big success badge */
function showBigBadge(msg){
  const b = document.createElement('div');
  b.style.position='fixed'; b.style.zIndex=11; b.style.left='50%'; b.style.top='30%';
  b.style.transform='translateX(-50%) scale(.75)'; b.style.padding='22px 28px'; b.style.borderRadius='14px';
  b.style.background='linear-gradient(90deg,var(--accent1),var(--accent2))'; b.style.color='#041018'; b.style.fontWeight=900; b.style.fontSize='18px';
  b.textContent = msg;
  document.body.appendChild(b);
  setTimeout(()=>{ b.style.transition='transform .5s ease'; b.style.transform='translateX(-50%) scale(1)'; },40);
  setTimeout(()=>{ b.style.transition='opacity .6s ease'; b.style.opacity=0; setTimeout(()=>b.remove(),1200); },5000);
}

/* reset progress */
resetBtn.addEventListener('click', ()=>{
  if (!confirm('Reset your local progress for this chapter?')) return;
  savedProgress = {}; localStorage.removeItem(PROG_KEY);
  // remove destroyed visuals and respawn (quick hack: reload)
  location.reload();
});

/* help button */
helpBtn.addEventListener('click', ()=>{ alert("Controls:\n - Move: Arrow keys or WASD\n - Approach asteroids to open lessons\n - Complete Theory/Video/Practice then CLEAN THE MESS\n - Progress saved locally\n\nTip: Replace placeholder assets later with your sprites and lecture links.") })

/* open lesson via asteroid element */
function openLessonModal(a){
  // freeze movement briefly
  activeAsteroid = a;
  openLessonModalInner(a);
}
function openLessonModalInner(a){
  // reuse earlier openLessonModal function to fill content
  openLessonModal(a); // our defined function above (ok to call again)
}

/* initial collision loop */
let lastCollisionTick = 0;
function collisionLoop(){
  if (state === 'explore'){
    // check every 120ms for collision
    if (performance.now() - lastCollisionTick > 120) { detectCollisions(); lastCollisionTick = performance.now(); }
  }
  requestAnimationFrame(collisionLoop);
}

/* main animate loop */
let state = 'dialogue'; // 'dialogue' | 'explore' | 'complete'
function mainLoop(){
  // update star twinkle already handled
  if (state === 'explore'){
    updatePlayer();
  }
  requestAnimationFrame(mainLoop);
}
requestAnimationFrame(mainLoop);
requestAnimationFrame(collisionLoop);

/* load progress AFTER spawn */
loadProgress();
updateProgressUI();

/* initial: place player element properly and make it follow "player" state */
function placePlayerAtCenter(){
  playerEl.style.left = (player.x) + 'px';
  playerEl.style.top = (player.y) + 'px';
}
placePlayerAtCenter();

/* set up performance-friendly star drawing */
let starTime = 0;
function starTick(ts){
  drawStars(ts);
  requestAnimationFrame(starTick);
}
requestAnimationFrame(starTick);

/* helper: drawStars reused from earlier but simplified */
function drawStars(now){
  sctx.clearRect(0,0,stars.width,stars.height);
  for (let s of starData){
    const a = s.alpha * (0.6 + 0.4*Math.sin(now*0.001*s.tw + s.phase));
    sctx.fillStyle = `rgba(255,255,255,${Math.max(0.05, Math.min(1, a))})`;
    sctx.fillRect(s.x, s.y, s.r, s.r);
  }
}

/* generate starData (quietly reusing earlier function) */
function regenerateStars(){
  stars.width = innerWidth; stars.height = innerHeight; gen();
}
function gen(){
  starData = [];
  const count = Math.round((innerWidth * innerHeight) / 6000);
  for (let i=0;i<count;i++){
    starData.push({
      x: Math.random()*innerWidth,
      y: Math.random()*innerHeight,
      r: Math.random()*1.6,
      alpha: 0.2 + Math.random()*0.8,
      tw: Math.random()*2 + 1.5,
      phase: Math.random()*Math.PI*2
    });
  }
}
gen();

/* initial dialogue is already started earlier; finalize by toggling state to explore when dialogue ends.
  The dialogue mechanism sets state='explore' when finished. We'll hook into that by overriding advanceDialogue to also hide the dialogue when done.
*/
(function overrideAdvance(){
  const old = advanceDialogue;
  advanceDialogue = function(){
    old();
    if (dIndex > dialogues.length - 1) { state = 'explore'; dialogue.style.display='none'; }
  }
})();

/* accessibility: show initial hint */
setTimeout(()=>{ if (dialogue.style.display!=='block') dialogue.style.display='block'; }, 200);

/* end of script */
</script>
<div id="root"></div>
<script src="chatbot/static/js/main.3a911f72.js"></script>
</body>
</html>
